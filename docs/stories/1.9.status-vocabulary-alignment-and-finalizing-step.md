# Story 1.9: Status Vocabulary Alignment (+ Optional "finalizing" at 90%) — Brownfield Addition

## Status

Approved

## User Story

As a user monitoring lead generation progress,
I want consistent status values across the database, edge functions, and frontend (including an optional "finalizing" step at 90%),
so that realtime updates are reliable and reflect true workflow state without dropped events.

## Context Source

- Origin: QA concerns in `Story 1.8` about a mismatch where `finalizing` (90%) appears in code/tests but is not allowed in DB CHECK
- Current integration: Supabase `lead_gen_jobs` table (Realtime), Edge functions `n8n-status-update`, `n8n-callback`, frontend `useLeadGeneration`
- Goal: Decide and implement one of two paths and align all layers accordingly

## Decision Options (select one and implement end-to-end)

- Option A — Adopt `finalizing` as an official intermediate status
  - DB CHECK includes `finalizing`
  - Mapping includes `finalizing → 90`
  - Edge and frontend handle and display `finalizing`
- Option B — Remove `finalizing` from code/tests/mapping
  - DB CHECK remains unchanged from Story 1.8
  - Edge and frontend stop emitting or referencing `finalizing`

## Acceptance Criteria

1. Status vocabulary is consistent across DB, edge functions, and frontend.
2. If Option A is chosen:
   - DB CHECK on `lead_gen_jobs.status` includes `finalizing`.
   - Realtime updates with `finalizing` are accepted and rendered at 90%.
3. If Option B is chosen:
   - No references to `finalizing` remain in frontend types, tests, or edge mappings.
   - Realtime updates contain only: `pending`, `processing`, `searching`, `enriching`, `validating`, `completed`, `failed`.
4. Status→progress mapping is centralized and covered by tests; UI reflects 10/40/60/70/(90 if A)/100.
5. No dropped updates due to DB CHECK constraint; end-to-end test passes for sequential updates.
6. Additive migration(s) are reversible; no breaking schema changes.

## Integration Requirements

- Database
  - Option A: Add migration to expand CHECK to include `finalizing`.
  - Option B: No DB change.
- Edge Functions (`n8n-status-update`, `n8n-callback`)
  - Ensure passthrough/write of allowed statuses only; map `progress` accordingly.
  - Update any default mapping/constants to match final vocabulary.
- Frontend (`useLeadGeneration` and UI components)
  - Update status union types and mapping utility.
  - Ensure tests cover all allowed statuses and sequential update handling.

## Quality

- Unit tests cover mapping and presence/absence of `finalizing` per chosen option.
- Integration test simulates sequential updates via Realtime and verifies UI progress changes in order within 1–2 seconds.
- No regressions to completion toast, leads loading, or error handling.

## Technical Notes

- Centralize mapping in a small helper (e.g., `statusToProgress(status, dbProgress?)`).
- Prefer using `progress` from DB when present; fall back to mapping for known statuses.
- Keep migrations additive and reversible; document rollback.

## Tasks / Subtasks

- [ ] PO decision: Choose Option A (adopt `finalizing`) or Option B (remove `finalizing`).
- [ ] Implement DB changes (if Option A):
  - [ ] Create migration to add `finalizing` to CHECK on `lead_gen_jobs.status`.
- [ ] Edge functions:
  - [ ] Align allowed statuses; ensure `finalizing` mapping (90) if Option A; remove if Option B.
  - [ ] Add/adjust logging for unknown statuses.
- [ ] Frontend:
  - [ ] Update type unions and mapping; ensure `validating @ 70` remains.
  - [ ] Add tests for mapping and sequential updates: `processing→searching→enriching→validating→(finalizing?)→completed`.
- [ ] QA:
  - [ ] Run end-to-end manual check to confirm no dropped updates and correct progress display.

## Definition of Done

- Vocabulary aligned across layers with the selected option implemented.
- Tests pass; realtime sequence renders all intended steps.
- No references to disallowed statuses remain.
- Migration (if any) is reversible.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-22 | 1.0 | Drafted Story 1.9 — Status vocabulary alignment | Scrum Master |
| 2025-08-22 | 1.1 | Approved | PO |

## QA Results

Decision: PASS

Summary:
- Vocabulary aligned with Option A; `finalizing` supported across DB, edge, and frontend.
- DB CHECK includes `finalizing`; migration added and reversible.
- Edge function accepts `finalizing` and maps to 90 by default; unknown statuses rejected.
- Frontend types and labels include `finalizing`; mapping centralized; UI renders 90% label correctly.
- Tests updated and passing (StatusBar finalizing case, mapping helper).

Verification Artifacts:
- DB Migration: `supabase/migrations/20250817010100_add_finalizing_status.sql`
- Edge: `supabase/functions/n8n-status-update/index.ts`
- Frontend: `src/lib/status.ts`, `src/hooks/useLeadGeneration.ts`, `src/components/StatusBar.tsx`, `src/components/LeadGenResults.tsx`
- Tests: `src/components/StatusBar.test.tsx`, `src/lib/status.test.ts`

Advisory (Non-blocking):
- Consider a safety auto-advance from `finalizing` to `completed` after a timeout if a final callback fails to arrive.