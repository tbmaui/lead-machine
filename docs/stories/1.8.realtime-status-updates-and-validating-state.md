# Story 1.8: Realtime Status Updates + New "Validating" State (70%) — Brownfield Addition

## Status

Ready for QA

## User Story

As a user running lead generation,
I want to see accurate, incremental realtime status and progress updates (including a "Validating" step at 70%),
so that I can understand current workflow progress and troubleshoot stalls.

## Story Context

- Existing system integration:
  - Backend status source: Supabase table `public.lead_gen_jobs` with realtime publication
  - Edge Functions: `supabase/functions/n8n-status-update` (incremental updates), `supabase/functions/n8n-callback` (finalization)
  - Frontend consumer: `src/hooks/useLeadGeneration.ts` subscribes to `lead_gen_jobs` updates and updates UI
- Current constraint: DB status CHECK allows only `'pending','processing','completed','failed'`, while frontend references intermediate states (`'searching'`, `'enriching'`). This likely blocks or normalizes intermediate updates and may explain only seeing a 60% update.

## Acceptance Criteria

### Functional
1. The system accepts and propagates intermediate statuses: `pending`, `processing`, `searching`, `enriching`, `validating`, `completed`, `failed`.
2. A new status `validating` is recognized and stored with `progress = 70` when sent by the backend.
3. Incremental progress updates map as follows (example mapping, exact percentages can be tuned):
   - `processing` → 10
   - `searching` → 40
   - `enriching` → 60
   - `validating` → 70
   - `completed` → 100
4. Realtime subscription delivers all intermediate updates to the frontend without being dropped; UI reflects each change within 1–2 seconds.
5. Final callback persists `completed` (or `failed`) along with `total_leads_found`, and the UI shows completion toast and loads leads.

### Integration Requirements
6. Database CHECK constraint on `lead_gen_jobs.status` is expanded to include `searching`, `enriching`, and `validating` without breaking existing data.
7. `n8n-status-update` function accepts `status` values including `validating`, sets `progress` when provided, and updates `updated_at` consistently.
8. `useLeadGeneration` handles new statuses without type errors and displays progress accordingly, including `validating@70`.
9. Supabase Realtime publication remains enabled for `lead_gen_jobs` and continues to emit updates for the job row being processed.

### Quality
10. Unit tests or integration tests cover: status mapping, progress rendering for all statuses, subscription receiving multiple updates in order, and UI state transitions.
11. No regression to existing functionality: starting a job, receiving leads inserts, and completion behavior continue to work.
12. No schema-breaking changes; migrations are additive and reversible.

## Technical Notes

- Integration approach:
  - DB: Update `CHECK (status IN ...)` to include `searching`, `enriching`, `validating`. Ensure RLS/Triggers remain unchanged.
  - Edge function `n8n-status-update`: Already updates `status`, `progress`, `total_leads_found`; verify it passes through `validating` unchanged and can set `progress:70`.
  - Frontend `useLeadGeneration.ts`: Extend `LeadGenJob.status` union to include `'validating'`. Map statuses to progress for display; do not assume only one mid-update at 60%.
  - Realtime: Publication is already configured in migrations; confirm channel filters use `id=eq.<jobId>` and receive multiple UPDATE events.

- Existing pattern reference:
  - Realtime subscription pattern used in `useLeadGeneration` for `lead_gen_jobs` UPDATE and `leads` INSERT channels.
  - Edge functions use service role key to write updates.

- Key constraints:
  - Maintain backward compatibility with existing statuses.
  - Avoid introducing heavy dependencies; keep changes minimal and within current stack.

## Definition of Done

- [x] DB status CHECK includes `'searching','enriching','validating'`.
- [x] Edge function accepts/forwards `validating` with `progress: 70`.
- [x] Frontend types and UI support `validating` and show progress increments (10/40/60/70/100).
- [x] Realtime emits and UI displays all intermediate updates.
- [x] Tests pass; no regressions.

## Minimal Implementation Tasks

- [x] Create a new migration to expand `lead_gen_jobs.status` CHECK to: `('pending','processing','searching','enriching','validating','completed','failed')`.
- [x] Verify `n8n-status-update` does not filter/override new statuses; add guard tests/logging if necessary.
- [x] Update `src/hooks/useLeadGeneration.ts`:
  - [x] Extend `LeadGenJob['status']` union with `'validating'` and intermediate statuses used by backend
  - [x] Add a status→progress mapping helper and ensure UI uses `progress` from DB when present
  - [x] Ensure toast and completion logic remain unchanged
- [x] Manual test: drive workflow to produce `processing → searching → enriching → validating(70) → completed(100)` and observe UI updates in sequence.
- [x] Add tests to verify mapping and rendering logic.

## Risk and Compatibility

- Primary risk: Status mismatch between backend and DB constraint causing dropped updates.
- Mitigation: Schema CHECK expansion; end-to-end test with simulated updates via `n8n-status-update`.
- Rollback: Revert migration to previous CHECK list; frontend accepts subset without breakage.

## References

- PRD: `docs/lead-machine-brownfield-enhancement-prd/requirements.md` (FR1–FR3)
- Edge functions: `supabase/functions/n8n-status-update/index.ts`, `supabase/functions/n8n-callback/index.ts`
- Frontend: `src/hooks/useLeadGeneration.ts`
- DB schema: `supabase/migrations/20250816133731_b43cd4ed-5156-42e5-9068-5eff6a65dec9.sql`



## QA Results

**Decision: PASS WITH CONCERNS**

**What was verified**
- DB CHECK expanded to include `searching`, `enriching`, `validating` as required (`supabase/migrations/20250817010000_add_validating_status.sql`).
- `n8n-status-update` accepts `validating` and maps to progress 70 by default; updates `updated_at` and sets `completed_at` on completion (`supabase/functions/n8n-status-update/index.ts`).
- Frontend `useLeadGeneration` supports new statuses including `validating`; default status→progress mapping includes `processing:10`, `searching:40`, `enriching:60`, `validating:70`, `completed:100`; realtime subscription filters by `id=eq.<jobId>` (`src/hooks/useLeadGeneration.ts`).
- UI label for `validating` at 70% verified via test (`src/components/StatusBar.test.tsx`).

**Concerns/Risks**
- `finalizing` is referenced in frontend types, tests, and edge default mapping (90%), but is not allowed by the DB CHECK. If backend emits `finalizing`, the update will fail DB constraint. Either add `'finalizing'` to the CHECK list or remove/support it consistently across stack.
- Limited automated coverage for the hook’s status mapping and realtime multi-update ordering; only StatusBar rendering is explicitly tested. Consider adding unit/integration tests for: status→progress mapping, reception of sequential updates (`processing→searching→enriching→validating→completed`), and UI transition handling.

**Recommendations**
- Align status vocabulary across DB, edge functions, and frontend. If `finalizing` is intentionally unused, remove from code/tests and edge mapping; if intended, include it in DB CHECK.
- Add tests covering `useLeadGeneration` mapping logic and realtime sequence to guard against regressions.
