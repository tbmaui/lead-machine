# Story 1.13: Leads Table Column Completeness and Layout Fix — Brownfield Hotfix

## Status

Approved

## Problem Statement

The current `LeadsTable` fails to display several fields delivered by the N8N workflow (NNN). Columns for Company, Phone, and Location show `N/A` despite data being present; columns for Company URL, Personal LinkedIn URL, and Company LinkedIn URL are missing entirely. The table typography is oversized and the main content container leaves excessive horizontal padding on wide screens, preventing space for required columns.

## User Story

As a sales user,
I need all fields provided by NNN to appear accurately in the leads table with compact typography and a wider viewport,
so that I can see company details and links without exporting or opening each lead.

## Scope

Frontend-only brownfield edits to rendering, mapping, and layout. No breaking API changes. Preserve existing quick-jump links, copy buttons, truncation/tooltips, and sorting behaviors (Stories 1.4–1.6, 1.11–1.12).

## Acceptance Criteria

1. Data mapping correctness
   - Company name, Phone, and Location cells render the values from NNN when present; `N/A` only when truly missing.
   - Location resolves from best available of: `city + state`, `state`, `region`, or `country` according to mapping rules below.
2. New columns present and functional
   - Company URL: clickable icon/button opening `website_url` in new tab.
   - Personal LinkedIn URL: clickable icon/button opening `personal_linkedin_url` in new tab.
   - Company LinkedIn URL: clickable icon/button opening `company_linkedin_url` in new tab.
   - All three links use `target="_blank"` and `rel="noopener noreferrer"` and do not interfere with sorting/selection.
3. Typography and density
   - Table font size reduced one step globally (e.g., `text-sm` → `text-xs` or equivalent), with row height adjusted to remain readable.
   - Cell paddings tightened to accommodate added columns without horizontal scroll at typical desktop widths (≥1440px).
4. Viewport/layout width
   - Main table container expands to use available width on large screens (e.g., increase max width to ≥ 1440–1600px and reduce side gutters), while remaining fully responsive on smaller screens.
5. Consistency with existing behaviors
   - Sorting (1.11), truncation/tooltips (1.6), copy buttons (1.5), and quick-jump links (1.4) continue to work without regression.
6. Accessibility and quality
   - All actionable icons have `aria-label`s.
   - Keyboard focus visible; header sort controls retain `aria-sort`.
   - Unit tests cover mapping, conditional rendering, and link attributes.

## Data Mapping Rules (from NNN payload → table props)

- company: `company` || `company_name`
- phone: prefer `phone` then `phone_number` then `work_phone`
- email: `email` (unchanged)
- website_url: prefer `company_website_url` then `website` then `domain` (normalized to `https://` if missing scheme)
- personal_linkedin_url: `linkedin_url` || `personal_linkedin_url`
- company_linkedin_url: `company_linkedin_url` || `linkedin_company_url`
- location display (best-effort):
  1) if `city` and `state` present → "${city}, ${state}"
  2) else `state` || `region`
  3) else `country`
  4) else empty → show `N/A`

All values should be trimmed; empty strings treated as missing.

## Integration Requirements

- `src/components/LeadsTable.tsx`
  - Ensure row model uses normalized fields listed above (derive once per row with `useMemo`).
  - Add three new URL columns (Company Website, Personal LinkedIn, Company LinkedIn) with icon buttons following 1.4 patterns.
  - Fix existing Company, Phone, Location cell renderers to consume normalized values.
  - Apply compact table density class and reduce default font size.
  - Adjust container/wrapper to allow wider max width on large screens.
- `src/components/LeadsTable.test.tsx`
  - Add tests for: correct mapping fallbacks, `N/A` only when truly missing, link attributes and conditional rendering, and regression checks for sorting/copy/truncation.

## Non-Functional Requirements

- Performance: No noticeable slowdown up to 5,000 rows (1.12 guidance still applies).
- Compatibility: No API changes; purely frontend mapping/normalization and rendering.
- A11y: Buttons/links labeled; focus states visible.

## Tasks / Subtasks

- [ ] Implement a `normalizeLead(row)` utility to compute: `displayCompany`, `displayPhone`, `displayEmail`, `displayLocation`, `websiteUrl`, `personalLinkedInUrl`, `companyLinkedInUrl`.
- [ ] Render fixed columns for Company, Phone, Location using normalized values; preserve truncation and copy/mailto behaviors.
- [ ] Add three URL columns with quick-jump icon buttons and `stopPropagation()`.
- [ ] Reduce font size and row padding; verify readability and density in light/dark modes.
- [ ] Expand max-width of table container on large screens and reduce side gutters.
- [ ] Unit tests covering mappings, conditionals, attributes, and no-regression checks for stories 1.4–1.6, 1.11–1.12.
- [ ] Manual QA on wide (≥1920px) and small viewports; confirm no horizontal scroll at ≥1440px when data present.

## Definition of Done

- All required columns displayed with correct data; three URL columns added.
- Typography and container width updated; table remains responsive.
- Tests pass; no regressions to related stories.
- No breaking changes to backend/N8N workflows.

## References

- PRD: FR7 (table columns), NFR1/NFR4 (smooth UX, performance)
- Existing stories: 1.4, 1.5, 1.6, 1.11, 1.12
- Component: `src/components/LeadsTable.tsx`
- Tests: `src/components/LeadsTable.test.tsx`

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-22 | 1.0 | Drafted Story 1.13 — Column completeness & layout fix | PM Agent |

## QA Results

Date: 2025-08-23
Reviewer: QA (Test Architect)

Decision: PASS

Summary:
- Data mapping corrected for Company, Phone, and Location; Location now resolves via city+state → state/region → country → fallback. Website, Personal LinkedIn, and Company LinkedIn normalized and rendered.
- New URL columns added as compact icon buttons with `target="_blank"` and `rel="noopener noreferrer"`; click propagation stopped.
- Typography density tightened (`text-xs`, reduced paddings) and main layout widened to max 1600px.
- Existing behaviors (sorting, truncation/tooltips, copy controls) verified via tests without regressions.
- A11y: aria-sort maintained; actionable icons include `aria-label`s.

Verification:
- Components: `src/components/LeadsTable.tsx`, `src/pages/Index.tsx`, `src/lib/filters.ts`.
- Tests: `src/components/LeadsTable.test.tsx` updated (industry + URL normalization), full suite passed (35/35).

Concerns/Notes:
- Performance at ~5,000 rows not empirically browser-tested; low risk given memoization and existing filtering approach.
- Manual QA recommended at ≥1920px to confirm no horizontal scroll at ≥1440px with dense data.

Exit Criteria:
- Keep PASS. Schedule manual perf and widescreen visual checks in next QA cycle.

### Gate Status

Gate: PASS → docs/qa/gates/1.13-leads-table-column-completeness-and-layout-fix.yml