# Story 1.7: Summary Pie Chart Above Leads Table — Brownfield Addition

## Status

Approved

## Story

As a sales user,
I want a summary pie chart above the leads table that visualizes lead quality dimensions (titles, valid phone, valid email),
so that I can quickly assess overall results at a glance without scanning individual rows.

## Context Source

- Source Document: Lead Machine Brownfield Enhancement PRD (FR4–FR6, NFR1–NFR4)
- Epic: Epic 1 — Refactor Lead Machine UI
- Existing System Impact: Read-only aggregation based on current leads dataset rendered in `LeadsTable`; no backend changes.

## Acceptance Criteria

Functional:
1. A pie (or donut) chart renders above the leads table when results are available.
2. The chart aggregates data into segments reflecting:
   - Title groupings (e.g., C-level, Director, Manager, Individual Contributor) OR top-N titles + "Other".
   - Presence of valid phone (yes/no).
   - Presence of valid email (yes/no).
3. The default view shows a combined "Quality" breakdown with the following segments: "Has Email", "Has Phone", "Both", "Neither". Exact segmenting can be toggled via small control chips: Quality | Titles.
4. Toggling to Titles switches the chart to show aggregated counts by title grouping with at most 6 slices (top-5 + Other).
5. Hover/focus on a segment shows a tooltip with segment name and count and percentage. Keyboard focus is supported.
6. The chart updates reactively when the leads dataset changes.
7. No horizontal scrolling is introduced; layout remains responsive for mobile and desktop.
8. Chart follows existing Neumorphism styling and color palette; remains WCAG AA contrast.

Integration/Quality:
9. No changes to backend or database; aggregation is computed client-side from the existing leads array shape used by `LeadsTable`.
10. Performance: aggregation and rendering are performant for up to 5,000 leads without noticeable UI jank.
11. Unit tests cover: aggregation logic (titles, phone/email), toggle behavior, tooltip content, and reactive updates when props change.
12. No regressions to `LeadsTable` interactions or layout; chart is visually separated and does not intercept table events.

## Dev Technical Guidance

### Existing System Context
- Data source: the same leads array rendered by `src/components/LeadsTable.tsx`.
- Tech stack: React + TypeScript, Tailwind CSS, shadcn/ui; Vite; existing components in `src/components/ui`.

### Integration Approach
- Create a `LeadsSummaryChart` component colocated under `src/components/` or `src/components/chart/` per `docs/lead-machine-brownfield-frontend-architecture-document/project-structure.md`.
- Input props: `{ leads: Lead[] }` where `Lead` is the existing type used by the table. Avoid new types if possible; extend locally if needed.
- Aggregation:
  - Quality view: derive counts for hasEmail, hasPhone, both, neither from row fields (truthy non-empty strings considered present). If validation util exists, reuse it.
  - Titles view: map titles to groups. Suggested grouping function: normalize to lowercase, match against ordered rules [c|chief|founder|owner] → C-level; [vp|vice] → VP; [director] → Director; [manager|lead|head] → Manager/Lead; else collect top-5 unique normalized titles and bucket remaining into "Other".
- State: local toggle state between "quality" and "titles" using segmented control (e.g., shadcn `ToggleGroup` or small `Button` group with aria-pressed).
- Rendering: Prefer a lightweight chart approach. Two options:
  1) Use the existing `src/components/ui/chart.tsx` abstraction if present to render a donut with provided data.
  2) If not suitable, render an SVG donut manually; avoid adding heavy chart dependencies.
- A11y: Provide `role="img"`, `aria-label` describing the dataset, and focusable segments if using custom SVG; ensure tooltips are accessible or fall back to title attributes.
- Styling: Apply Neumorphism container similar to `.neu-form-section` with subtle elevation; use brand yellow→green gradient accents for active slice/legend.

### Technical Constraints
- No new backend calls; strictly client-side aggregation.
- No large dependencies; prefer built-in or existing chart utility.
- Respect NFR1 performance and NFR2/NFR3 styling consistency.

### Missing Information
- Confirm existing `Lead` shape: exact keys for `title`, `phone`, `email` and any validation helpers.
- Confirm whether `src/components/ui/chart.tsx` provides a donut ready component; otherwise implement minimal SVG donut.

## Tasks / Subtasks

- [ ] Analyze current leads data shape and utilities
  - [ ] Inspect `src/components/LeadsTable.tsx` for field names and patterns
  - [ ] Reuse any validation helpers for email/phone if available
- [ ] Implement `LeadsSummaryChart` component
  - [ ] Build aggregation functions for quality and titles
  - [ ] Implement lightweight donut rendering using existing `ui/chart.tsx` or custom SVG
  - [ ] Add toggle between Quality and Titles views
  - [ ] Ensure responsive/neumorphism styling and a11y
- [ ] Integrate chart into the results view
  - [ ] Render above the table in `LeadGenResults` or appropriate page component
  - [ ] Ensure no interference with table events/layout
- [ ] Add unit tests
  - [ ] Test aggregation logic with sample datasets
  - [ ] Test toggle view switching and tooltip content
  - [ ] Test reactive updates when `leads` prop changes
- [ ] Manual QA and performance check
  - [ ] Validate no horizontal scroll introduced; responsive on small screens
  - [ ] Confirm performance with large dataset (mock 5,000 rows)

## Risk Assessment

### Implementation Risks
- Primary Risk: Chart dependency bloat or performance issues with large datasets.
- Mitigation: Use lightweight rendering (SVG) or existing minimal chart utility; precompute aggregates with O(n) complexity.
- Verification: Unit test aggregation; measure render times; check for UI jank.

### Rollback Plan
- Revert the addition of `LeadsSummaryChart` and its integration edits; table remains unaffected.

### Safety Checks
- [ ] Existing table verified before integration
- [ ] Changes isolated behind a distinct component
- [ ] Rollback steps documented

## Definition of Done
- Functional and integration acceptance criteria met
- Tests pass (existing + new)
- No regressions in the leads table
- Styling matches Neumorphism guidelines and brand palette
- Documentation note added in README or component-level docs

## References
- PRD: `docs/lead-machine-brownfield-enhancement-prd/requirements.md` (FR4–FR6)
- Architecture: `docs/lead-machine-brownfield-frontend-architecture-document/styling-guidelines.md`, `project-structure.md`, `testing-requirements.md`


