# Story 3.2: Authentication & Access Control System

## Status

Draft

## Story

**As a** client receiving the Lead Machine application for production deployment,
**I want** a comprehensive authentication and access control system that requires users to sign in before accessing lead generation functionality,
**so that** I can control who accesses the sensitive lead generation capabilities, track usage by authenticated users, and ensure compliance with enterprise security requirements for my organization.

## Acceptance Criteria

1. **User Authentication System**
   - Implement Supabase Auth integration with email/password authentication
   - Remove anonymous access to lead generation functionality
   - Add secure user registration and login forms with proper validation
   - Implement password reset and account management capabilities

2. **Protected Route System** 
   - Protect all lead generation functionality behind authentication
   - Implement route guards that redirect unauthenticated users to login
   - Create authenticated and unauthenticated layout components
   - Ensure seamless user experience for authenticated users

3. **Session Management & Security**
   - Implement secure session management with automatic token refresh
   - Add proper session timeout and security controls
   - Handle session expiration gracefully with user-friendly prompts
   - Implement secure logout functionality that clears all session data

4. **User Profile Management**
   - Create user profile page with account information and settings
   - Allow users to update profile information and change passwords  
   - Implement user preferences and configuration management
   - Add usage tracking and history for authenticated users

5. **Access Control & Authorization**
   - Implement role-based access control (RBAC) foundation for future expansion
   - Add user activity logging and audit trails
   - Enforce authentication requirements in all API endpoints and Supabase RLS policies
   - Create admin capabilities for user management (foundational structure)

## Tasks / Subtasks

- [ ] **Authentication Infrastructure Setup** (AC: 1, 3)
  - [ ] Configure Supabase Auth with email/password provider  
  - [ ] Update Supabase RLS policies to require authentication for lead_gen_jobs and leads tables
  - [ ] Remove anonymous access patterns from `useLeadGeneration.ts` hook
  - [ ] Update Supabase client configuration for authenticated sessions

- [ ] **Login & Registration Components** (AC: 1)
  - [ ] Create `LoginForm` component with email/password validation
  - [ ] Create `RegisterForm` component with user registration flow
  - [ ] Implement `ForgotPasswordForm` component for password reset
  - [ ] Add form validation using react-hook-form and zod schemas
  - [ ] Create authentication success/error states and messaging

- [ ] **Route Protection & Navigation** (AC: 2)
  - [ ] Implement `ProtectedRoute` component wrapper
  - [ ] Create `AuthenticatedLayout` and `UnauthenticatedLayout` components
  - [ ] Update main `Index.tsx` to check authentication state
  - [ ] Add navigation components for authenticated users (logout, profile)
  - [ ] Implement redirect logic for unauthenticated users

- [ ] **Session Management** (AC: 3)
  - [ ] Enhance `useAuth` hook with complete session management
  - [ ] Implement automatic token refresh functionality
  - [ ] Add session timeout detection and user prompts
  - [ ] Create secure logout functionality with session cleanup
  - [ ] Add loading states and error handling for auth operations

- [ ] **User Profile & Account Management** (AC: 4)
  - [ ] Create `UserProfile` component and route
  - [ ] Implement profile update functionality
  - [ ] Add password change capability
  - [ ] Create user preferences management
  - [ ] Add user activity history tracking

- [ ] **Authorization & Security Controls** (AC: 5) 
  - [ ] Implement foundational RBAC system with user roles
  - [ ] Add user activity logging and audit trail
  - [ ] Update all API calls to include proper authentication headers
  - [ ] Create admin user management foundation (user listing, role assignment)
  - [ ] Add security monitoring and suspicious activity detection

- [ ] **Testing & Security Validation** (AC: 1, 2, 3, 5)
  - [ ] Add comprehensive authentication flow testing
  - [ ] Test route protection and unauthorized access attempts
  - [ ] Validate session management and timeout functionality  
  - [ ] Test password reset and account recovery flows
  - [ ] Perform security testing for authentication bypass attempts
  - [ ] Validate Supabase RLS policies block unauthorized access

## Dev Notes

### Current Authentication Analysis

[Source: Production Readiness Assessment, current codebase analysis]

**CRITICAL SECURITY GAPS IDENTIFIED:**

```typescript
// src/hooks/useAuth.ts - CURRENT INSECURE IMPLEMENTATION
const signInAnonymously = async () => {
  // ❌ FAKE AUTH - Creates fake user without actual authentication
  const tempUser = {
    id: crypto.randomUUID(),
    email: 'demo@example.com',
    user_metadata: {}
  } as User;
  setUser(tempUser);
  return tempUser;
};
```

```typescript
// src/hooks/useLeadGeneration.ts - ANONYMOUS ACCESS ALLOWED
const effectiveUserId = userId || crypto.randomUUID(); // ❌ ALLOWS ANONYMOUS ACCESS
```

**CURRENT VULNERABILITIES:**
- Lead generation accessible without any authentication
- Fake user creation allows bypassing all security controls
- No session management or access control enforcement
- Database operations allowed for anonymous users
- No audit trail or user activity tracking

### Supabase Auth Integration Requirements

[Source: Supabase documentation, security best practices]

**REQUIRED CONFIGURATION:**

```typescript
// src/integrations/supabase/client.ts - SECURE IMPLEMENTATION
export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    storage: localStorage,
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true
  }
});
```

**REQUIRED AUTH PROVIDERS:**
- **Email/Password**: Primary authentication method for enterprise users
- **Password Reset**: Email-based password recovery system
- **Session Management**: Automatic token refresh with secure storage
- **Profile Management**: User profile updates and preferences

### Database Security & RLS Policies

[Source: Current Supabase schema, security requirements]

**CURRENT INSECURE TABLES:**
- `lead_gen_jobs` - Currently allows anonymous access
- `leads` - No authentication requirements
- Missing user profile and activity tracking tables

**REQUIRED RLS POLICIES:**

```sql
-- Enable RLS on all tables
ALTER TABLE lead_gen_jobs ENABLE ROW LEVEL SECURITY;
ALTER TABLE leads ENABLE ROW LEVEL SECURITY;

-- Only authenticated users can access their own jobs
CREATE POLICY "Users can access own lead gen jobs" ON lead_gen_jobs
  FOR ALL USING (auth.uid() = user_id);

-- Only authenticated users can access leads from their jobs
CREATE POLICY "Users can access own leads" ON leads  
  FOR ALL USING (
    auth.uid() IN (
      SELECT user_id FROM lead_gen_jobs WHERE id = leads.job_id
    )
  );
```

**NEW TABLES REQUIRED:**
- `user_profiles` - Extended user profile information
- `user_activity_logs` - Audit trail for user actions
- `user_preferences` - User configuration and preferences

### Authentication Flow Architecture  

[Source: React Router patterns, Supabase Auth patterns]

**REQUIRED COMPONENT HIERARCHY:**

```
App.tsx
├── AuthProvider (Context for auth state)
├── Router
  ├── UnauthenticatedLayout
  │   ├── LoginForm
  │   ├── RegisterForm  
  │   └── ForgotPasswordForm
  └── ProtectedRoute
      └── AuthenticatedLayout
          ├── Header (with logout, profile)
          ├── Index (lead generation)
          └── UserProfile
```

**ROUTE PROTECTION PATTERN:**

```typescript
// src/components/ProtectedRoute.tsx
export const ProtectedRoute = ({ children }: { children: React.ReactNode }) => {
  const { user, loading } = useAuth();
  
  if (loading) return <LoadingSpinner />;
  if (!user) return <Navigate to="/login" replace />;
  
  return <>{children}</>;
};
```

### Enhanced useAuth Hook Implementation

[Source: Current implementation analysis, Supabase Auth patterns]

**REQUIRED SECURE IMPLEMENTATION:**

```typescript
// src/hooks/useAuth.ts - SECURE VERSION
export const useAuth = () => {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  
  // Remove signInAnonymously - NOT ALLOWED IN PRODUCTION
  
  const signIn = async (email: string, password: string) => {
    const { data, error } = await supabase.auth.signInWithPassword({
      email, 
      password
    });
    if (error) throw error;
    return data;
  };
  
  const signUp = async (email: string, password: string) => {
    const { data, error } = await supabase.auth.signUp({
      email,
      password
    });
    if (error) throw error;
    return data;
  };
  
  const signOut = async () => {
    const { error } = await supabase.auth.signOut();
    if (error) throw error;
  };
  
  return { user, loading, signIn, signUp, signOut };
};
```

### Component Design & User Experience

[Source: Current UI components, neumorphism design system]

**AUTHENTICATION UI REQUIREMENTS:**
- **Consistent Design**: Use established neumorphism styling and component patterns
- **Form Validation**: React Hook Form with Zod validation schemas  
- **Error Handling**: User-friendly error messages and loading states
- **Accessibility**: WCAG AA compliance for form controls and navigation
- **Mobile Responsive**: Full responsive design for authentication flows

**KEY COMPONENTS TO CREATE:**
- `LoginForm` - Email/password login with validation
- `RegisterForm` - User registration with email verification
- `ForgotPasswordForm` - Password reset flow
- `UserProfile` - Profile management and settings
- `AuthenticatedHeader` - Navigation with user menu and logout

### File Structure and Locations

[Source: Current project structure analysis]

**FILES TO CREATE:**
- `src/components/auth/LoginForm.tsx` - Login form component
- `src/components/auth/RegisterForm.tsx` - Registration form
- `src/components/auth/ForgotPasswordForm.tsx` - Password reset form
- `src/components/auth/ProtectedRoute.tsx` - Route protection component
- `src/components/auth/AuthenticatedLayout.tsx` - Layout for authenticated users
- `src/components/auth/UnauthenticatedLayout.tsx` - Layout for login/register
- `src/pages/Login.tsx` - Login page
- `src/pages/Register.tsx` - Registration page
- `src/pages/UserProfile.tsx` - User profile management
- `src/lib/auth-schemas.ts` - Zod validation schemas for auth forms

**FILES TO MODIFY:**
- `src/hooks/useAuth.ts` - Replace with secure authentication implementation
- `src/hooks/useLeadGeneration.ts` - Remove anonymous access, require authentication
- `src/pages/Index.tsx` - Add authentication checks and protected route wrapper
- `src/App.tsx` - Add authentication routing and context provider
- `src/integrations/supabase/types.ts` - Add user profile and auth-related types

### Database Schema Requirements

[Source: Supabase schema patterns, user management requirements]

**MIGRATION FILES TO CREATE:**

```sql
-- Create user profiles table
CREATE TABLE user_profiles (
  id UUID REFERENCES auth.users ON DELETE CASCADE,
  email TEXT NOT NULL,
  full_name TEXT,
  company TEXT,
  job_title TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  PRIMARY KEY (id)
);

-- Create user activity logs
CREATE TABLE user_activity_logs (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  action TEXT NOT NULL,
  details JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Update existing tables to require authentication
ALTER TABLE lead_gen_jobs ALTER COLUMN user_id SET NOT NULL;
```

### Security & Compliance Requirements

[Source: Production readiness assessment, enterprise security standards]

**SECURITY CONTROLS REQUIRED:**
- **Password Policy**: Minimum 8 characters, complexity requirements  
- **Account Lockout**: Protection against brute force attacks
- **Session Security**: Secure token storage and automatic refresh
- **Audit Logging**: Complete activity trail for all user actions
- **Data Protection**: Encryption at rest and in transit

**COMPLIANCE CONSIDERATIONS:**
- **SOC 2**: User access controls and activity monitoring
- **GDPR**: User data protection and right to deletion
- **Enterprise**: Integration with client SSO systems (future expansion)

### Testing Requirements

[Source: docs/lead-machine-brownfield-frontend-architecture-document/testing-requirements.md]

**REQUIRED TEST COVERAGE:**
- **Authentication Flow Tests**: Login, registration, password reset flows
- **Route Protection Tests**: Unauthorized access attempts and redirects
- **Session Management Tests**: Token refresh, timeout, and logout functionality
- **Form Validation Tests**: Input validation and error handling
- **Security Tests**: Authentication bypass attempts and unauthorized access
- **Integration Tests**: Supabase Auth integration and RLS policy enforcement

**TEST FILES TO CREATE:**
- `src/hooks/useAuth.test.ts` - Authentication hook testing
- `src/components/auth/LoginForm.test.tsx` - Login form component testing  
- `src/components/auth/ProtectedRoute.test.tsx` - Route protection testing
- `src/lib/auth-schemas.test.ts` - Validation schema testing
- `e2e/auth-flow.spec.ts` - End-to-end authentication testing

### Performance & User Experience

[Source: Core Web Vitals requirements, UX best practices]

**PERFORMANCE REQUIREMENTS:**
- **Fast Authentication**: Login/logout operations complete in <2 seconds
- **Smooth Redirects**: Seamless navigation between authenticated/unauthenticated states  
- **Caching**: Proper session caching to avoid unnecessary re-authentication
- **Loading States**: Clear loading indicators during authentication operations

**USER EXPERIENCE STANDARDS:**
- **Progressive Enhancement**: Graceful degradation for authentication failures
- **Clear Messaging**: User-friendly error messages and success feedback
- **Accessibility**: Full keyboard navigation and screen reader support
- **Mobile First**: Optimized authentication flows for mobile devices

### Integration with Existing Systems

[Source: Current implementation analysis]

**PRESERVATION REQUIREMENTS:**
- **UI Consistency**: Maintain neumorphic design system and component styling
- **Feature Flags**: Preserve existing feature flag system
- **Data Flow**: Maintain existing lead generation workflow after authentication
- **API Integration**: Preserve N8N webhook integration with authenticated users
- **Real-time Updates**: Maintain Supabase real-time subscriptions for authenticated users

**MIGRATION STRATEGY:**
- Phase 1: Implement authentication system alongside existing anonymous access
- Phase 2: Test authentication with feature flag control
- Phase 3: Remove anonymous access and enforce authentication
- Phase 4: Full security validation and production deployment

### Technical Constraints

**CRITICAL AUTHENTICATION REQUIREMENTS:**
- **Zero Anonymous Access**: No lead generation functionality without authentication  
- **Session Security**: Secure token management and automatic refresh
- **Database Security**: All database operations require authenticated user context
- **Audit Requirements**: Complete activity logging for compliance
- **Enterprise Ready**: Foundation for SSO and advanced authentication methods

**PERFORMANCE CONSTRAINTS:**
- Authentication operations must complete in <2 seconds
- Route protection must not impact page load performance
- Session management must not cause memory leaks or performance degradation
- Authentication state changes must update UI in <100ms

### Project Structure Alignment

[Source: docs/lead-machine-brownfield-frontend-architecture-document/]

All authentication system changes align with established project structure:
- Authentication components follow `/src/components/auth/` organization
- Authentication utilities follow `/src/lib/` pattern for schemas and helpers
- Authentication pages follow `/src/pages/` routing structure  
- No structural conflicts identified with current architecture

## Testing

### Test Requirements

[Source: docs/lead-machine-brownfield-frontend-architecture-document/testing-requirements.md]

**TESTING FRAMEWORK:** Vitest with jsdom environment, @testing-library/react

**REQUIRED TEST COVERAGE:**
- **Unit Tests**: Authentication hooks, form components, validation schemas
- **Integration Tests**: Supabase Auth integration, RLS policy enforcement
- **Component Tests**: Authentication forms, route protection, user profile management
- **Security Tests**: Authentication bypass attempts, session security validation
- **E2E Tests**: Complete authentication flows from registration to logout

**COVERAGE GOAL:** 90% coverage for all authentication and authorization code

**CRITICAL TEST SCENARIOS:**
- **Happy Path**: Successful registration, login, profile updates, logout
- **Error Handling**: Invalid credentials, network failures, session expiration
- **Security**: Unauthorized access attempts, session manipulation, CSRF protection
- **Edge Cases**: Concurrent sessions, token refresh failures, database connection issues

## Change Log

| Date       | Version | Description                                                                    | Author              |
| :--------- | :------ | :----------------------------------------------------------------------------- | :------------------ |
| 2025-08-28 | 1.0     | Initial story creation for Epic 3 authentication and access control system    | Scrum Master Bob    |