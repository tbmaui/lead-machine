# Story 1.10: Stuck Status Recovery and Auto-Advance Safeguard — Brownfield Addition

## Status

Draft

## User Story

As a user monitoring lead generation,
I want the system to automatically recover from a stuck "finalizing" or near-complete state and complete jobs when safe,
so that transient callback failures do not leave the UI indefinitely at 90% and block my workflow.

## Context Source

- Origin: Advisory in `Story 1.9` QA Results suggesting an auto-advance from `finalizing` to `completed` after a timeout if the final callback fails to arrive.
- Existing flow: Edge function `n8n-status-update` emits intermediate statuses; `n8n-callback` finalizes with totals; DB table `lead_gen_jobs` drives Realtime updates to UI.
- Constraints: Additive and reversible; must not mark jobs completed prematurely or hide failures.

## Acceptance Criteria

1. When a job reaches `finalizing` (or `progress >= 90`) and does not receive a terminal update within a configurable timeout, the system attempts a safe auto-advance.
2. Safe auto-advance only occurs if there have been no error signals and the job has remained unchanged since entering the near-complete state.
3. On auto-advance success, the job transitions to `completed`, sets `completed_at`, and preserves the last known `total_leads_found` (or 0 if absent) without overwriting higher values.
4. If an explicit terminal update (`completed` or `failed`) arrives later, it supersedes the auto-advance result (last-write-wins with monotonic precedence for `failed`).
5. Timeout is configurable (default 90s) and stored in environment or configuration; test may use shorter window.
6. Observability: an audit/log entry is recorded for auto-advance attempts and outcomes.
7. Frontend reflects the completed state after auto-advance and proceeds to fetch/display leads as in normal completion.
8. No regressions to realtime sequencing; intermediate updates still render in order.

## Integration Requirements

- Database
  - No schema change required. Optionally add an index on `lead_gen_jobs.status, updated_at` to support scheduled checks if needed.

- Edge Functions
  - Update `supabase/functions/n8n-status-update/index.ts` or add a small scheduled function to perform the auto-advance check:
    - Detect jobs stuck in `finalizing` (or `progress >= 90`) beyond timeout with no newer updates.
    - Perform conditional update with a guard on `updated_at` to avoid races.
  - Ensure idempotency and clear logs for audit.

- Frontend
  - No UI changes required; ensure `useLeadGeneration` handles auto-advanced `completed` like normal completion.
  - Add test to confirm UI transitions to 100% and loads leads after an auto-advance event.

## Quality

- Unit tests for auto-advance selector and guard conditions (time-based logic can be injected/mocked).
- Integration test simulating: `... → finalizing(90)` then no events; after timeout, auto-advance to `completed(100)`; UI updates and loads leads.
- Logging verified; no double-complete side effects; explicit `failed` later overrides to failed.

## Technical Notes

- Use a monotonic precedence: `failed` > `completed` > intermediate. Apply compare-and-set using `updated_at` or a revision to avoid clobbering newer writes.
- Prefer implementing as a lightweight periodic job (cron) or timeout scheduling triggered by entering `finalizing` state.
- Config surface: `AUTO_FINALIZE_TIMEOUT_SEC` with sensible default; document in `.env.example`.

## Tasks / Subtasks

- [ ] PO: Confirm scope and default timeout (proposed 90s).
- [ ] Edge function implementation:
  - [ ] Add scheduled handler or inline timer logic to detect stuck near-complete jobs.
  - [ ] Implement guarded update to `completed` with audit logging.
  - [ ] Add configuration read for `AUTO_FINALIZE_TIMEOUT_SEC`.
- [ ] Frontend:
  - [ ] Add a test ensuring that a `completed` update arriving after `finalizing` without explicit callback triggers normal completion flow.
- [ ] QA:
  - [ ] Manual test: drive to `finalizing`, skip callback, wait timeout, observe auto-advance to 100% and leads load.
  - [ ] Manual test: explicit `failed` after auto-advance should set status to `failed`.

## Definition of Done

- Auto-advance works under safe conditions; configurable timeout; logs recorded.
- Tests pass (unit + integration) without regressions.
- Behavior is additive and reversible; disabling the feature restores prior flow.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-22 | 1.0 | Drafted Story 1.10 — Auto-advance safeguard | Scrum Master |


